name: Deploy RDS Scanner to AWS

on:
  push:
    branches:
      - main
      - production
    paths:
      - 'rds-scanner-cloudformation.yaml'
      - 'parameters.json'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  AWS_REGION: us-east-1
  STACK_NAME: rds-scanner

jobs:
  validate:
    name: Validate CloudFormation Template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate CloudFormation template
        run: |
          aws cloudformation validate-template \
            --template-body file://rds-scanner-cloudformation.yaml

  deploy:
    name: Deploy CloudFormation Stack
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create parameters file
        run: |
          cat > parameters.json <<EOF
          [
            {
              "ParameterKey": "SlackWebhookURL",
              "ParameterValue": "${{ secrets.SLACK_WEBHOOK_URL }}"
            },
            {
              "ParameterKey": "ScanRegions",
              "ParameterValue": "${{ secrets.SCAN_REGIONS || 'us-east-1,us-west-2' }}"
            },
            {
              "ParameterKey": "ProjectName",
              "ParameterValue": "rds-scanner"
            },
            {
              "ParameterKey": "LambdaTimeout",
              "ParameterValue": "900"
            },
            {
              "ParameterKey": "LambdaMemorySize",
              "ParameterValue": "512"
            },
            {
              "ParameterKey": "ReportRetentionDays",
              "ParameterValue": "90"
            },
            {
              "ParameterKey": "CPUThreshold",
              "ParameterValue": "50"
            },
            {
              "ParameterKey": "TransactionThreshold",
              "ParameterValue": "50"
            }
          ]
          EOF

      - name: Check if stack exists
        id: check-stack
        run: |
          if aws cloudformation describe-stacks --stack-name ${{ env.STACK_NAME }} 2>/dev/null; then
            echo "stack_exists=true" >> $GITHUB_OUTPUT
          else
            echo "stack_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create CloudFormation stack
        if: steps.check-stack.outputs.stack_exists == 'false'
        run: |
          aws cloudformation create-stack \
            --stack-name ${{ env.STACK_NAME }} \
            --template-body file://rds-scanner-cloudformation.yaml \
            --parameters file://parameters.json \
            --capabilities CAPABILITY_NAMED_IAM \
            --tags Key=ManagedBy,Value=GitHub-Actions Key=Repository,Value=${{ github.repository }}

          echo "Waiting for stack creation to complete..."
          aws cloudformation wait stack-create-complete \
            --stack-name ${{ env.STACK_NAME }}

      - name: Update CloudFormation stack
        if: steps.check-stack.outputs.stack_exists == 'true'
        run: |
          aws cloudformation update-stack \
            --stack-name ${{ env.STACK_NAME }} \
            --template-body file://rds-scanner-cloudformation.yaml \
            --parameters file://parameters.json \
            --capabilities CAPABILITY_NAMED_IAM || echo "No updates to be performed"

          echo "Waiting for stack update to complete..."
          aws cloudformation wait stack-update-complete \
            --stack-name ${{ env.STACK_NAME }} || echo "Stack update completed or no changes"

      - name: Get stack outputs
        run: |
          echo "### Stack Outputs" >> $GITHUB_STEP_SUMMARY
          aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query 'Stacks[0].Outputs[*].[OutputKey,OutputValue]' \
            --output text | while IFS=$'\t' read -r key value; do
              echo "- **$key**: $value" >> $GITHUB_STEP_SUMMARY
            done

      - name: Test Lambda function
        run: |
          echo "Testing Lambda function..."
          FUNCTION_NAME=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`LambdaFunctionName`].OutputValue' \
            --output text)
          
          aws lambda invoke \
            --function-name $FUNCTION_NAME \
            --payload '{"is_monday": true}' \
            response.json
          
          echo "### Lambda Test Result" >> $GITHUB_STEP_SUMMARY
          cat response.json | jq . >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            STATUS="✅ Success"
            COLOR="good"
          else
            STATUS="❌ Failed"
            COLOR="danger"
          fi
          
          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d '{
              "attachments": [{
                "color": "'"$COLOR"'",
                "title": "RDS Scanner Deployment",
                "text": "Deployment Status: '"$STATUS"'",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "'"${{ github.repository }}"'",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "'"${{ github.ref_name }}"'",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "'"${{ github.sha }}"'",
                    "short": true
                  },
                  {
                    "title": "Actor",
                    "value": "'"${{ github.actor }}"'",
                    "short": true
                  }
                ]
              }]
            }'
