name: Weekly AWS Resource Monitor

on:
  schedule:
    # Run every Monday at 9:00 AM UTC (1:00 AM PST / 4:00 AM EST)
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-2

jobs:
  scan-dev-environment:
    name: Scan Dev Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements-monitor.txt

      - name: Assume AWS Dev role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::477873552632:role/devops-deploy-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: |
          aws sts get-caller-identity

      - name: Scan Dev resources
        run: |
          python3 -u aws_resource_monitor.py \
            --skip-slack \
            --output-json dev-results.json \
            --dev-profile "" \
            --environments dev \
            --region ${{ env.AWS_REGION }}
        env:
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Upload Dev JSON results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dev-results
          path: dev-results.json
          retention-days: 7
          if-no-files-found: ignore

  scan-stage-environment:
    name: Scan Stage Environment
    runs-on: ubuntu-latest
    needs: scan-dev-environment
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements-monitor.txt

      - name: Assume AWS Stage role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::221203628080:role/devops-deploy-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: |
          aws sts get-caller-identity

      - name: Scan Stage resources
        run: |
          python3 -u aws_resource_monitor.py \
            --skip-slack \
            --output-json stage-results.json \
            --stage-profile "" \
            --environments stage \
            --region ${{ env.AWS_REGION }}
        env:
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Upload Stage JSON results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stage-results
          path: stage-results.json
          retention-days: 7
          if-no-files-found: ignore

  scan-prod-environment:
    name: Scan Prod Environment
    runs-on: ubuntu-latest
    needs: scan-stage-environment
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements-monitor.txt

      - name: Assume AWS Prod role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::947618278001:role/devops-deploy-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: |
          aws sts get-caller-identity

      - name: Scan Prod resources
        run: |
          python3 -u aws_resource_monitor.py \
            --skip-slack \
            --output-json prod-results.json \
            --prod-profile "" \
            --environments prod \
            --region ${{ env.AWS_REGION }}
        env:
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Upload Prod JSON results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: prod-results
          path: prod-results.json
          retention-days: 7
          if-no-files-found: ignore

  send-consolidated-slack-notification:
    name: Send Consolidated Slack Notification
    runs-on: ubuntu-latest
    needs: [scan-dev-environment, scan-stage-environment, scan-prod-environment]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Download Dev results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: dev-results
          path: results/

      - name: Download Stage results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: stage-results
          path: results/

      - name: Download Prod results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: prod-results
          path: results/

      - name: List downloaded results
        run: |
          echo "Downloaded results:"
          ls -la results/ || echo "No results found"

      - name: Consolidate and send Slack notification
        env:
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          python3 consolidate_and_notify.py \
            --json-dir results/ \
            --slack-webhook "${{ secrets.SLACK_WEBHOOK_URL }}"

  notify-completion:
    name: Notify Scan Completion
    runs-on: ubuntu-latest
    needs: [scan-dev-environment, scan-stage-environment, scan-prod-environment, send-consolidated-slack-notification]
    if: always()
    steps:
      - name: Send completion notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ "${{ needs.scan-dev-environment.result }}" == "success" ] && [ "${{ needs.scan-stage-environment.result }}" == "success" ] && [ "${{ needs.scan-prod-environment.result }}" == "success" ]; then
            STATUS="Success"
            EMOJI=":white_check_mark:"
            COLOR="good"
          else
            STATUS="Failed"
            EMOJI=":x:"
            COLOR="danger"
          fi

          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d '{
              "attachments": [{
                "color": "'"$COLOR"'",
                "title": "'"$EMOJI"' Weekly AWS Resource Monitor Scan Complete",
                "text": "Status: '"$STATUS"'",
                "fields": [
                  {
                    "title": "Workflow",
                    "value": "Weekly AWS Resource Monitor",
                    "short": true
                  },
                  {
                    "title": "Dev Status",
                    "value": "'"${{ needs.scan-dev-environment.result }}"'",
                    "short": true
                  },
                  {
                    "title": "Stage Status",
                    "value": "'"${{ needs.scan-stage-environment.result }}"'",
                    "short": true
                  },
                  {
                    "title": "Prod Status",
                    "value": "'"${{ needs.scan-prod-environment.result }}"'",
                    "short": true
                  },
                  {
                    "title": "Run ID",
                    "value": "'"${{ github.run_id }}"'",
                    "short": true
                  }
                ],
                "footer": "GitHub Actions",
                "ts": '"$(date +%s)"'
              }]
            }'
