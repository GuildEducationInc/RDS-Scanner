name: Weekly AWS Resource Monitor

on:
  schedule:
    # Run every Monday at 9:00 AM UTC (1:00 AM PST / 4:00 AM EST)
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-2

jobs:
  scan-dev-environment:
    name: Scan Dev Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements-monitor.txt

      - name: Assume AWS Dev role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::477873552632:role/devops-deploy-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: |
          aws sts get-caller-identity

      - name: Scan Dev resources
        run: |
          python3 -u aws_resource_monitor.py \
            --slack-webhook "${{ secrets.SLACK_WEBHOOK_URL }}" \
            --dev-profile "" \
            --environments dev \
            --region ${{ env.AWS_REGION }}
        env:
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Upload Dev CSV report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: dev-resource-report
          path: aws_resource_report_*.csv
          retention-days: 30

  scan-stage-environment:
    name: Scan Stage Environment
    runs-on: ubuntu-latest
    needs: scan-dev-environment
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements-monitor.txt

      - name: Assume AWS Stage role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::221203628080:role/devops-deploy-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: |
          aws sts get-caller-identity

      - name: Scan Stage resources
        run: |
          python3 -u aws_resource_monitor.py \
            --slack-webhook "${{ secrets.SLACK_WEBHOOK_URL }}" \
            --stage-profile "" \
            --environments stage \
            --region ${{ env.AWS_REGION }}
        env:
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Upload Stage CSV report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: stage-resource-report
          path: aws_resource_report_*.csv
          retention-days: 30

  send-combined-report:
    name: Send Combined Report to Slack
    runs-on: ubuntu-latest
    needs: [scan-dev-environment, scan-stage-environment]
    if: always()
    steps:
      - name: Download Dev report
        uses: actions/download-artifact@v3
        with:
          name: dev-resource-report
          path: reports/dev

      - name: Download Stage report
        uses: actions/download-artifact@v3
        with:
          name: stage-resource-report
          path: reports/stage

      - name: List downloaded reports
        run: |
          echo "Dev reports:"
          ls -la reports/dev/ || echo "No dev reports found"
          echo ""
          echo "Stage reports:"
          ls -la reports/stage/ || echo "No stage reports found"

  notify-completion:
    name: Notify Scan Completion
    runs-on: ubuntu-latest
    needs: [scan-dev-environment, scan-stage-environment, send-combined-report]
    if: always()
    steps:
      - name: Send completion notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ "${{ needs.scan-dev-environment.result }}" == "success" ] && [ "${{ needs.scan-stage-environment.result }}" == "success" ]; then
            STATUS="Success"
            EMOJI=":white_check_mark:"
            COLOR="good"
          else
            STATUS="Failed"
            EMOJI=":x:"
            COLOR="danger"
          fi

          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d '{
              "attachments": [{
                "color": "'"$COLOR"'",
                "title": "'"$EMOJI"' Weekly AWS Resource Monitor Scan Complete",
                "text": "Status: '"$STATUS"'",
                "fields": [
                  {
                    "title": "Workflow",
                    "value": "Weekly AWS Resource Monitor",
                    "short": true
                  },
                  {
                    "title": "Dev Status",
                    "value": "'"${{ needs.scan-dev-environment.result }}"'",
                    "short": true
                  },
                  {
                    "title": "Stage Status",
                    "value": "'"${{ needs.scan-stage-environment.result }}"'",
                    "short": true
                  },
                  {
                    "title": "Run ID",
                    "value": "'"${{ github.run_id }}"'",
                    "short": true
                  }
                ],
                "footer": "GitHub Actions",
                "ts": '"$(date +%s)"'
              }]
            }'
